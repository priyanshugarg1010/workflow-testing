name: Update CHANGELOG on PR merge (Test)

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  update-changelog:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        run: |
          # Simulate checkout - in act this will use the local directory
          pwd
          ls -la

      - name: Configure git
        run: |
          git config user.name "[bot] Changelog Updater"
          git config user.email "changelog-bot@github.com"

      - name: Extract PR details
        id: pr
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          NUMBER="${{ github.event.pull_request.number }}"
          URL="${{ github.event.pull_request.html_url }}"
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "number=$NUMBER" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          
          echo "Processing PR: $TITLE"
          
          # Check if PR should be ignored (starts with "internal" - case insensitive)
          if [[ "$TITLE" =~ ^[Ii][Nn][Tt][Ee][Rr][Nn][Aa][Ll] ]]; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "✓ This PR will be skipped (Internal)"
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
            echo "✓ This PR will be processed"
          fi
          
          # Check if PR is a release (starts with "release" - case insensitive)
          if [[ "$TITLE" =~ ^[Rr][Ee][Ll][Ee][Aa][Ss][Ee] ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            # Extract version number
            VERSION=$(echo "$TITLE" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\+[0-9]+')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "✓ Release PR detected - Version: $VERSION"
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "✓ Normal PR"
          fi

      - name: Update CHANGELOG.md
        if: steps.pr.outputs.should_skip == 'false'
        run: |
          TITLE="${{ steps.pr.outputs.title }}"
          NUMBER="${{ steps.pr.outputs.number }}"
          URL="${{ steps.pr.outputs.url }}"
          IS_RELEASE="${{ steps.pr.outputs.is_release }}"
          VERSION="${{ steps.pr.outputs.version }}"
          
          echo "Updating CHANGELOG.md..."
          
          # Create CHANGELOG.md if it doesn't exist
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "## Latest Release" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          # Process based on PR type
          if [ "$IS_RELEASE" = "true" ]; then
            echo "→ Adding release version section: $VERSION"
            export VERSION
            export NUMBER
            export URL
            python3 << 'PYTHON_SCRIPT'
          import re
          import sys
          import os
          
          version = os.environ.get('VERSION')
          pr_number = os.environ.get('NUMBER')
          pr_url = os.environ.get('URL')
          
          with open('CHANGELOG.md', 'r') as f:
              content = f.read()
          
          new_section = f"### [{version}]({pr_url})"
          content = re.sub(
              r'## Latest Release',
              f'## Latest Release\n\n{new_section}',
              content,
              count=1
          )
          
          with open('CHANGELOG.md', 'w') as f:
              f.write(content)
          
          print(f"✓ Added release section for version {version}")
          PYTHON_SCRIPT
          else
            echo "→ Adding PR entry"
            export TITLE
            export NUMBER
            export URL
            python3 << 'PYTHON_SCRIPT'
          import re
          import os
          
          title = os.environ.get('TITLE')
          pr_number = os.environ.get('NUMBER')
          pr_url = os.environ.get('URL')
          repo = "${{ github.repository }}"
          
          with open('CHANGELOG.md', 'r') as f:
              content = f.read()
          
          pr_entry = f"- [{repo}#{pr_number}]({pr_url}) {title}"
          pattern = r'(## Latest Release\s*\n)'
          
          if re.search(pattern, content):
              content = re.sub(
                  pattern,
                  r'\1' + pr_entry + '\n',
                  content,
                  count=1
              )
          else:
              content = "# Changelog\n\n## Latest Release\n" + pr_entry + "\n\n" + content
          
          with open('CHANGELOG.md', 'w') as f:
              f.write(content)
          
          print(f"✓ Added PR entry: {title}")
          PYTHON_SCRIPT
          fi
          
          echo ""
          echo "Updated CHANGELOG.md:"
          cat CHANGELOG.md

      - name: Show changes
        if: steps.pr.outputs.should_skip == 'false'
        run: |
          echo "Git status:"
          git status
          
          echo ""
          echo "Git diff:"
          git diff CHANGELOG.md || echo "No changes to diff"
