name: Update release on PR merge

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  update-release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "[bot] release Updater"
          git config user.email "release-bot@github.com"

      - name: Extract PR details
        id: pr
        run: |
          echo "TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
          echo "NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV

      - name: Determine release section
        id: section
        run: |
          TITLE="${{ env.TITLE }}"

          if [[ "$TITLE" == feat* ]]; then
            echo "SECTION=Added" >> $GITHUB_ENV
          elif [[ "$TITLE" == fix* ]]; then
            echo "SECTION=Fixed" >> $GITHUB_ENV
          elif [[ "$TITLE" == refactor* ]]; then
            echo "SECTION=Changed" >> $GITHUB_ENV
          elif [[ "$TITLE" == breaking* ]]; then
            echo "SECTION=Breaking Changes" >> $GITHUB_ENV
          else
            echo "SECTION=Changed" >> $GITHUB_ENV
          fi

      - name: Update release.md
        run: |
          DATE=$(date +"%Y-%m-%d")
          ENTRY="- ${TITLE} (#${NUMBER})"

          if ! grep -q "## \[Unreleased\]" release.md; then
            echo -e "## [Unreleased]\n" | cat - release.md > temp && mv temp release.md
          fi

          awk -v section="### $SECTION" -v entry="$ENTRY" '
            BEGIN { added=0 }
            {
              print
              if ($0 == section && !added) {
                print entry
                added=1
              }
            }
          ' release.md > tmp && mv tmp release.md

      - name: Prepare PR branch
        run: |
          BRANCH="release-update-pr-${{ env.NUMBER }}"
          git checkout -b "$BRANCH"
          git add release.md
          git commit -m "chore(release): update from PR #${{ env.NUMBER }}"
          git push origin "$BRANCH"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "Update release from PR #${{ env.NUMBER }}" \
            --body "Auto-generated release update for merged PR #${{ env.NUMBER }}\n\nOriginal PR: ${{ github.event.pull_request.html_url }}" \
            --reviewer "${{ github.event.pull_request.user.login }}"
