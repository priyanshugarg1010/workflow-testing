name: Update release on PR merge

on:
  push:
    branches:
      - main

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "[bot] Changelog Updater"
          git config user.email "changelog-bot@github.com"

      - name: Get merged PR for commit
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR=$(gh pr list \
            --state merged \
            --search "${GITHUB_SHA}" \
            --json title,number,url \
            --jq '.[0]')

          if [ "$PR" = "null" ]; then
            echo "No PR found for this commit"
            exit 0
          fi

          echo "TITLE=$(echo "$PR" | jq -r .title)" >> $GITHUB_ENV
          echo "NUMBER=$(echo "$PR" | jq -r .number)" >> $GITHUB_ENV
          echo "URL=$(echo "$PR" | jq -r .url)" >> $GITHUB_ENV

      - name: Update CHANGELOG.md
        run: |
          FILE="CHANGELOG.md"
          TITLE="$TITLE"

          # Ensure base header exists
          if ! grep -q "^## Flutter 3.38 Changes" "$FILE"; then
            sed -i '1s/^/## Flutter 3.38 Changes\n\n/' "$FILE"
          fi

          # Ignore internal PRs
          if [[ "$TITLE" =~ ^[Ii][Nn][Tt][Ee][Rr][Nn][Aa][Ll] ]]; then
            echo "Ignoring internal PR"
            exit 0
          fi

          # Handle Release PR
          if [[ "$TITLE" =~ ^[Rr]elease\ build\ ([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            VERSION="${BASH_REMATCH[1]}"
            TAG_URL="https://github.com/${GITHUB_REPOSITORY}/releases/tag/${VERSION}"

            awk -v v="$VERSION" -v url="$TAG_URL" '
              BEGIN { inserted=0 }
              /^## Flutter 3.38 Changes/ {
                print
                print ""
                print "### [" v "](" url ")"
                print ""
                inserted=1
                next
              }
              { print }
            ' "$FILE" > tmp.md

            mv tmp.md "$FILE"
            exit 0
          fi

          # Normal PR entry
          ENTRY="- [#${NUMBER}](${URL}) ${TITLE}"

          awk -v entry="$ENTRY" '
            BEGIN { added=0 }
            /^### \[/ && !added {
              print
              print entry
              added=1
              next
            }
            { print }
          ' "$FILE" > tmp.md

          mv tmp.md "$FILE"

      - name: Commit and push
        run: |
          git add CHANGELOG.md
          git commit -m "chore(changelog): update from PR #${NUMBER}" || exit 0
          git push origin main
